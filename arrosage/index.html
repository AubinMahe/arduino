<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />
<title>Contrôle de l'arrosage</title>
<style>
* {
margin:0;
padding:0;
box-sizing: border-box;
font: 14px Arial, sans-serif;
}
body {
margin: 2px;
text-align: center;
}
.content {
display: inline-block;
width: 316px;
}
#status-line {
font-size: 16px;
font-style: italic;
}
.pane {
border: 1px solid darkgray;
text-align: center;
margin:4px;
}
.pane > p {
display: block;
background-color: lightgray;
padding: 4px;
font-size: 18px;
font-weight: bold;
cursor: pointer; 
}
.pane > div {
display: none;
margin: 4px;
}
.pane div > input {
vertical-align: middle;
}
input[type=time] {
height: 30px;
width : 72px;
}
table {
display: inline-block;
border-collapse: collapse;
}
.pane > button {
margin: 4px;
}
th, td {
border: 1px solid #ddd;
}
tr:nth-child(even) {
background-color: #f2f2f2;
}
th {
padding: 2px;
font-weight: bold;
}
td {
text-align: center;
}   
td > input {
width: 100%;
vertical-align: middle;
}
th:nth-child(1), td:nth-child(1) {
width: 48px;
}   
th:nth-child(2), td:nth-child(2), th:nth-child(4), td:nth-child(4) {
width: 32px;
}   
th:nth-child(3), td:nth-child(3), th:nth-child(5), td:nth-child(5) {
width: 42px;
}
td:nth-child(1) > input {
height: 24px;
}
td:nth-child(3) > input, td:nth-child(5) > input {
height: 24px;
}
td:nth-child(3) > input, td:nth-child(5) > input {
text-align: right;
}
td:nth-child(2) > select {
width: 180px;
vertical-align: middle;
}
</style>
<script type="text/javascript"> 
var arrosage  = null;
var http      = new XMLHttpRequest();

function instant_to_hhmm( instant ) {
   var hh = instant.heure;
   if( hh < 10 ) {
      hh = '0' + hh;
   }
   var mm = instant.minute;
   if( mm < 10 ) {
      mm = '0' + mm;
   }
   var hhmm = hh + ':' + mm;
   for( var i = 1; i < arguments.length; ++i ) {
      document.getElementById( arguments[i] ).value = hhmm;
   }
   return hhmm;
}

function hhmm_to_instant( id ) {
   var hm = document.getElementById( id ).value.split(':');
   return {
      heure : parseInt( hm[0] ),
      minute: parseInt( hm[1] )
   };
}

function get_duree( id ) {
   return parseInt( document.getElementById( id ).value );
}

function set_duree( duree, id ) {
   document.getElementById( id ).value = duree;
}

function lire_la_configuration() {
   var cmd = {commande: "Lire la configuration"};
   console.log( "Commande : %o", cmd );
   http.onreadystatechange = function( event ) {
      if( this.readyState === XMLHttpRequest.DONE ) {
         if( this.status === 200 ) {
            try {
               console.log( this.responseText );
               var configuration = JSON.parse( this.responseText );
               if( configuration.code === 0 ) {
                  var arrosage = configuration.data.arrosage;
                  instant_to_hhmm( configuration.data.arrosage.horloge,
                     "heure", "heure_de_la_configuration" );
                  document.getElementById( "est_en_marche" ).value = arrosage.est_en_marche;
                  for( var pin = 0; pin < arrosage.vannes.length; ++pin ) {
                     var vanne = arrosage.vannes[pin];
                     var vm    = "vanne-" + pin + "-matin-";
                     var vs    = "vanne-" + pin + "-soir-";
                     instant_to_hhmm( vanne.matin.ouverture, vm + "ouverture" );
                     set_duree      ( vanne.matin.duree    , vm + "duree" );
                     instant_to_hhmm( vanne.soir .ouverture, vs + "ouverture"  );
                     set_duree      ( vanne.soir .duree    , vs + "duree"  );
                  }
                  document.getElementById( "status-line" ).innerText = "Configuration chargée."; 
               }
               else {
                  document.getElementById( "status-line" ).innerText = configuration.msg; 
               }
            }
            catch( x ) {
               console.error( x );
               document.getElementById( "status-line" ).innerText = "Erreur interne !";
            }
         }
      }
   };
   http.open( 'POST', location.host, true );
   http.setRequestHeader( "Content-type", "application/json" );
   http.send( JSON.stringify( cmd ));
}

function send( cmd ) {
   console.log( "send: -%o-", cmd );
   http.onreadystatechange = function( event ) {
      if( this.readyState === XMLHttpRequest.DONE ) {
         if( this.status === 200 ) {
            try {
               console.log( this.responseText );
               var configuration = JSON.parse( this.responseText );
               if( configuration.code === 0 ) {
                  document.getElementById( "status-line" ).innerText = "Commande exécutée.";
               }
               else if( configuration.msg ) {
                  document.getElementById( "status-line" ).innerText = configuration.msg; 
               }
               else {
                  document.getElementById( "status-line" ).innerText = "Erreur interne !"; 
               }
            }
            catch( x ) {
               console.error( x );
               document.getElementById( "status-line" ).innerText = "Erreur interne !";
            }
         }
      }
   };
   http.open( 'POST', location.host, true );
   http.setRequestHeader( "Content-type", "application/json" );
   http.send( JSON.stringify( cmd ));
}

function demarrer_ou_arreter() {
   var on_off = document.getElementById( "on-off" ).checked;
   send({commande: "Démarrer ou arrêter", argument: {demarrer: on_off }});   
}

function auto_test() {
   send({commande: "Auto-test", argument: {demarrer: true }});   
}

function mettre_a_l_heure() {
   send({commande: "Mettre à l'heure", argument: hhmm_to_instant( "heure" )});   
}

function ouvrir_ou_fermer_les_vannes() {
   var msg = {
      commande: "Ouvrir ou fermer les vannes",
      argument: {
         les_vannes: [],
      },
   };
   for( var pin = 0; pin < 4; ++pin ) {
      var etat = parseInt( document.getElementById( "of-vanne-" + pin + "-etat" ).value );
      if( etat != 0 ) {
         msg.argument.les_vannes.push({ pin : pin, etat: etat });
      }
   }
   if( msg.argument.les_vannes.length ) {
      send( msg );   
   }
}

function charger_une_configuration() {
   var les_vannes = [];
   for( var pin = 0; pin < 4; ++pin ) {
      var vm = "vanne-" + pin + "-matin-";
      var vs = "vanne-" + pin + "-soir-";
      les_vannes.push({
         matin: {
            ouverture: hhmm_to_instant( vm + "ouverture" ),
            duree    : get_duree      ( vm + "duree"     )
         },
         soir : {
            ouverture: hhmm_to_instant( vs + "ouverture"  ),
            duree    : get_duree      ( vs + "duree"      )
         }
      });
   }
   var cfg = {
      arrosage: {
         est_en_marche: document.getElementById( "est_en_marche" ).checked,
         horloge      : hhmm_to_instant( "heure_de_la_configuration" ),
         vannes       : les_vannes
      }
   };
   send({commande: "Charger une configuration", argument: cfg});
}

function expand_or_collapse( p ) {
   var div = p.nextElementSibling;
   if( div.style.display != 'block' ) {
      div.style.display = 'block';
         var panes = document.getElementsByClassName( 'pane' );
         for( var i = 0; i < panes.length; ++i ) {
         var pane = panes[i];
         if( pane.firstElementChild != p ) {
            pane.getElementsByTagName('div')[0].style.display = 'none';
         }
      }
   }
   else {
      div.style.display = 'none';
   }
}
</script>
</head>
<body onload="lire_la_configuration()">
<div class="content">
<div class="pane"><p onclick="expand_or_collapse(this)">Démarrer ou arrêter</p><div>
<label for="on-off">En fonctionnement :</label>
<input id="on-off" type="checkbox" style="vertical-align: middle;" />
<br/>
<button onclick="demarrer_ou_arreter()">Commander</button>
</div></div>
<div class="pane"><p onclick="expand_or_collapse(this)">Auto-test</p><div>
<label for="autotest">Auto-test : 24 h en 2 min, 24 sec :</label>
<button onclick="auto_test()">Commander</button>
</div></div>
<div class="pane"><p onclick="expand_or_collapse(this)">Mettre à l'heure</p><div>
<label for="mettre_a_l_heure">Heure:minute :</label>
<input id="heure" type="time" />
<br/>
<button onclick="mettre_a_l_heure()">Commander</button>
</div></div>
<div class="pane"><p onclick="expand_or_collapse(this)">Commande manuelle des vannes</p><div>
<table>
<thead>
<tr>
<th>Pin</th>
<th>État</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><select id="of-vanne-0-etat">
<option value="0" selected="selected">Ne pas commander</option>
<option value="1">Selon la configuration</option>
<option value="3">Ouverte</option>
<option value="4">Fermée</option>
</select></td>
</tr>
<tr>
<td>1</td>
<td><select id="of-vanne-1-etat">
<option value="0" selected="selected">Ne pas commander</option>
<option value="1">Selon la configuration</option>
<option value="3">Ouverte</option>
<option value="4">Fermée</option>
</select></td>
</tr>
<tr>
<td>2</td>
<td><select id="of-vanne-2-etat">
<option value="0" selected="selected">Ne pas commander</option>
<option value="1">Selon la configuration</option>
<option value="3">Ouverte</option>
<option value="4">Fermée</option>
</select></td>
</tr>
<tr>
<td>3</td>
<td><select id="of-vanne-3-etat">
<option value="0" selected="selected">Ne pas commander</option>
<option value="1">Selon la configuration</option>
<option value="3">Ouverte</option>
<option value="4">Fermée</option>
</select></td>
</tr>
</tbody>
</table>
<br/>
<button onclick="ouvrir_ou_fermer_les_vannes()">Commander</button>
</div></div>
<div class="pane"><p onclick="expand_or_collapse(this)">Lire ou charger une configuration</p><div>
<label for="heure_de_la_configuration">Heure:minute :</label>
<input id ="heure_de_la_configuration" type="time" />
<br/>
<label for="est_en_marche">En fonctionnement :</label>
<input id="est_en_marche" type="checkbox" style="vertical-align: middle;" />
<br/>
<table>
<thead>
<tr>
<th rowspan="2">Pin</th>
<th colspan="2">Matin</th>
<th colspan="2">Soir</th>
</tr>
<tr>
<th>Heure</th>
<th>Durée</th>
<th>Heure</th>
<th>Durée</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><input id="vanne-0-matin-ouverture" type="time" /></td>
<td><input id="vanne-0-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-0-soir-ouverture"  type="time" /></td>
<td><input id="vanne-0-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
<tr>
<td>1</td>
<td><input id="vanne-1-matin-ouverture" type="time" /></td>
<td><input id="vanne-1-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-1-soir-ouverture"  type="time" /></td>
<td><input id="vanne-1-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
<tr>
<td>2</td>
<td><input id="vanne-2-matin-ouverture" type="time" /></td>
<td><input id="vanne-2-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-2-soir-ouverture"  type="time" /></td>
<td><input id="vanne-2-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
<tr>
<td>3</td>
<td><input id="vanne-3-matin-ouverture" type="time" /></td>
<td><input id="vanne-3-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-3-soir-ouverture"  type="time" /></td>
<td><input id="vanne-3-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
</tbody>
</table>
<br/>
<button onclick="lire_la_configuration()">Lire</button>
<button onclick="charger_une_configuration()">Charger</button>
</div></div>
<p id="status-line">Lecture de la configuration en cours...</p>
</div>
</body>
</html>
