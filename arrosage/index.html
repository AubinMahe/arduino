<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />
<title>Contrôle de l'arrosage</title>
<style>
* {
margin:0;
padding:0;
box-sizing: border-box;
font: 14px Arial, sans-serif;
}
body {
margin: 2px;
text-align: center;
}
.content {
display: inline-block;
width: 316px;
}
.pane {
border: 1px solid darkgray;
text-align: center;
margin:4px;
}
.pane > p {
display: block;
background-color: lightgray;
padding: 4px;
font-size: 18px;
font-weight: bold;
cursor: pointer; 
}
.pane > div {
display: none;
margin: 4px;
}
.pane div > input {
vertical-align: middle;
}
input[type=time] {
height: 30px;
width : 72px;
}
table {
display: inline-block;
border-collapse: collapse;
}
.pane > button {
margin: 4px;
}
th, td {
border: 1px solid #ddd;
}
tr:nth-child(even) {
background-color: #f2f2f2;
}
th {
padding: 2px;
font-weight: bold;
}
td {
text-align: center;
}   
td > input {
width: 100%;
vertical-align: middle;
}
th:nth-child(1), td:nth-child(1) {
width: 32px;
}   
th:nth-child(2), td:nth-child(2), th:nth-child(4), td:nth-child(4) {
width: 32px;
}   
th:nth-child(3), td:nth-child(3), th:nth-child(5), td:nth-child(5) {
width: 42px;
}
td:nth-child(1) > input {
height: 24px;
}
td:nth-child(3) > input, td:nth-child(5) > input {
height: 24px;
}
td:nth-child(3) > input, td:nth-child(5) > input {
text-align: right;
}
</style>
<script type="text/javascript"> 
var arrosage  = null;
var http      = new XMLHttpRequest();

function hhmm( instant ) {
   var hh = instant.heure;
   if( hh < 10 ) {
      hh = '0' + hh;
   }
   var mm = instant.minute;
   if( mm < 10 ) {
      mm = '0' + mm;
   }
   return hh + ':' + mm;
}
function lire_la_configuration() {
   var cmd = {commande: "Lire la configuration"};
   console.log( "Commande : %o", cmd );
   
   http.onreadystatechange = function( event ) {
      if( this.readyState === XMLHttpRequest.DONE ) {
         if( this.status === 200 ) {
            //console.log( this.responseText );
            var configuration = JSON.parse( this.responseText );
            if( configuration.code === 0 ) {
               var heure    = configuration.data.heure;
               var arrosage = configuration.data.arrosage;
               var ts       = hhmm( heure );
               document.getElementById( "heure" ).value = ts; 
               document.getElementById( "heure_de_la_configuration" ).value = ts;
               document.getElementById( "est_en_marche" ).value = arrosage.est_en_marche;
               for( var pin = 0; pin < arrosage.vannes.length; ++pin ) {
                  var vanne = arrosage.vannes[pin];
                  var mo    = document.getElementById( "vanne-" + pin + "-matin-ouverture" );
                  var md    = document.getElementById( "vanne-" + pin + "-matin-duree"     );
                  var so    = document.getElementById( "vanne-" + pin + "-soir-ouverture"  );
                  var sd    = document.getElementById( "vanne-" + pin + "-soir-duree"      );
                  mo .value = hhmm( vanne.matin.ouverture );
                  md .value = vanne.matin.duree;
                  so .value = hhmm( vanne.soir .ouverture );
                  sd .value = vanne.soir.duree;
               }
            }
         }
      }
   };
   http.open( 'POST', location.host, true );
   http.setRequestHeader( "Content-type", "application/json" );
   http.send( JSON.stringify( cmd ));
}

function send( cmd ) {
   console.log( "send: -%o-", cmd );
   http.onreadystatechange = function( event ) {};
   http.open( 'POST', location.host, true );
   http.setRequestHeader( "Content-type", "application/json" );
   http.send( JSON.stringify( cmd ));
}

function demarrer_ou_arreter() {
   var on_off = document.getElementById( "on-off" ).checked;
   send({commande: "Démarrer ou arrêter", argument: {demarrer: on_off }});   
}

function mettre_a_l_heure() {
   var hm = document.getElementById( "heure" ).value.split(':');
   var instant = {
      heure : parseInt( hm[0] ),
      minute: parseInt( hm[1] )
   };
   send({commande: "Mettre à l'heure", argument: instant});   
}

function ouvrir_ou_fermer_les_vannes() {
   var msg = {
      commande: "Ouvrir ou fermer les vannes",
      argument: {
         les_vannes: [],
      },
   };
   for( var row = 0; row < 4; ++row ) {
      var pin = document.getElementById( "of-vanne-" + row + "-pin" );
      if( pin.value > -1 ) {
         msg.argument.les_vannes.push({
            pin   : parseInt( pin.value ),
            ouvrir: document.getElementById( "of-vanne-" + row + "-etat" ).checked,
         });
      }
   }
   send( msg );   
}

function charger_une_configuration() {
   var hm = document.getElementById( "heure_de_la_configuration" ).value.split(':');
   var instant = {
      heure : parseInt( hm[0] ),
      minute: parseInt( hm[1] )
   };
   var les_vannes = [];
   for( var pin = 0; pin < 4; ++pin ) {
      hm = document.getElementById( "vanne-" + pin + "-matin-ouverture" ).value.split(':');
      var om = {
         heure : parseInt( hm[0] ),
         minute: parseInt( hm[1] )
      };
      hm = document.getElementById( "vanne-" + pin + "-soir-ouverture" ).value.split(':');
      var os = {
         heure : parseInt( hm[0] ),
         minute: parseInt( hm[1] )
      };
      les_vannes.push({
         pin  : parseInt( pin.value ),
         matin: {
            ouverture: om,
            duree    : parseInt( document.getElementById( "vanne-" + pin + "-matin-duree" ).value )
         },
         soir : {
            ouverture: os,
            duree    : parseInt( document.getElementById( "vanne-" + pin + "-soir-duree" ).value )
         }
      });
   }
   var cfg = {
      heure   : instant,
      arrosage: {
         est_en_marche: document.getElementById( "est_en_marche" ).checked,
         vannes       : les_vannes
      }
   };
   send({commande: "Charger une configuration", argument: cfg});
}

function expand_or_collapse( p ) {
   var div = p.nextElementSibling;
   if( div.style.display != 'block' ) {
      div.style.display = 'block';
         var panes = document.getElementsByClassName( 'pane' );
         for( var i = 0; i < panes.length; ++i ) {
         var pane = panes[i];
         if( pane.firstElementChild != p ) {
            pane.getElementsByTagName('div')[0].style.display = 'none';
         }
      }
   }
   else {
      div.style.display = 'none';
   }
}
</script>
</head>
<body onload="lire_la_configuration()">
<div class="content">
<div class="pane"><p onclick="expand_or_collapse(this)">Démarrer ou arrêter</p><div>
<label for="on-off">En fonctionnement :</label>
<input id="on-off" type="checkbox" style="vertical-align: middle;" />
<br/>
<button onclick="demarrer_ou_arreter()">Commander</button>
</div></div>
<div class="pane"><p onclick="expand_or_collapse(this)">Mettre à l'heure</p><div>
<label for="mettre_a_l_heure">Heure:minute :</label>
<input id ="heure" type="time" />
<br/>
<button onclick="mettre_a_l_heure()">Commander</button>
</div></div>
<div class="pane"><p onclick="expand_or_collapse(this)">Ouvrir ou fermer les vannes</p><div>
<table>
<thead>
<tr>
<th>Pin</th>
<th>État</th>
</tr>
</thead>
<tbody>
<tr>
<td><input id="of-vanne-0-pin"  type="number" min="-1" max="3" value="-1" /></td>
<td><input id="of-vanne-0-etat" type="checkbox" /></td>
</tr>
<tr>
<td><input id="of-vanne-1-pin"  type="number" min="-1" max="3" value="-1" /></td>
<td><input id="of-vanne-1-etat" type="checkbox" /></td>
</tr>
<tr>
<td><input id="of-vanne-2-pin"  type="number" min="-1" max="3" value="-1" /></td>
<td><input id="of-vanne-2-etat" type="checkbox" /></td>
</tr>
<tr>
<td><input id="of-vanne-3-pin"  type="number" min="-1" max="3" value="-1" /></td>
<td><input id="of-vanne-3-etat" type="checkbox" /></td>
</tr>
</tbody>
</table>
<br/>
<button onclick="ouvrir_ou_fermer_les_vannes()">Commander</button>
</div></div>
<div class="pane"><p onclick="expand_or_collapse(this)">Lire ou charger une configuration</p><div>
<label for="heure_de_la_configuration">Heure:minute :</label>
<input id ="heure_de_la_configuration" type="time" />
<br/>
<label for="est_en_marche">En fonctionnement :</label>
<input id="est_en_marche" type="checkbox" style="vertical-align: middle;" />
<br/>
<table>
<thead>
<tr>
<th rowspan="2">Pin</th>
<th colspan="2">Matin</th>
<th colspan="2">Soir</th>
</tr>
<tr>
<th>Heure</th>
<th>Durée</th>
<th>Heure</th>
<th>Durée</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><input id="vanne-0-matin-ouverture" type="time" /></td>
<td><input id="vanne-0-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-0-soir-ouverture"  type="time" /></td>
<td><input id="vanne-0-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
<tr>
<td>1</td>
<td><input id="vanne-1-matin-ouverture" type="time" /></td>
<td><input id="vanne-1-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-1-soir-ouverture"  type="time" /></td>
<td><input id="vanne-1-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
<tr>
<td>2</td>
<td><input id="vanne-2-matin-ouverture" type="time" /></td>
<td><input id="vanne-2-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-2-soir-ouverture"  type="time" /></td>
<td><input id="vanne-2-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
<tr>
<td>3</td>
<td><input id="vanne-3-matin-ouverture" type="time" /></td>
<td><input id="vanne-3-matin-duree"     type="number" min="5" max="90" /></td>
<td><input id="vanne-3-soir-ouverture"  type="time" /></td>
<td><input id="vanne-3-soir-duree"      type="number" min="5" max="90" /></td>
</tr>
</tbody>
</table>
<br/>
<button onclick="lire_la_configuration()">Lire</button>
<button onclick="charger_une_configuration()">Charger</button>
</div></div>
</div>
</body>
</html>
